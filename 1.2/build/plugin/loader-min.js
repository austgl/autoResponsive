/*! autoResponsive - v1.2 - 2013-07-19 11:08:59 AM
* Copyright (c) 2013 xudafeng; Licensed  */
KISSY.add("gallery/autoResponsive/1.2/plugin/loader",function(e){"use strict";function t(e){return this instanceof t?(this._makeCfg(e),void 0):new t(e)}function i(t,i,n,r){var o,s={},a=[],u=n.config,l=u.qpt||15;return s.start=function(){a=a.concat(e.makeArray(t));var u=function(){for(var e=+new Date;a.length>0&&50>new Date-e;){var c=a.splice(0,l);i.call(n,c)}return a.length>0?(o=setTimeout(u,25),void 0):(r&&r.call(n,t),s.stop(),s=null,void 0)};u()},s.stop=function(){o&&(clearTimeout(o),a=[])},s}function n(e,t,i,n){var r;return function(){function o(){n||e.apply(s,a),r=null}var s=i||this,a=arguments;r?clearTimeout(r):n&&e.apply(s,a),r=setTimeout(o,t||100)}}var r=e.DOM,o=e.Event,s=window,a=50;return e.augment(t,e.EventTarget,{init:function(e){this.owner=e,this.__bindMethods(),this._reset()},_reset:function(){var e=this,t=e.config,i=t.mod;e.__started=e.__destroyed=e.__stopped=0,"manual"===i||(e.__onScroll(),e.start())},_makeCfg:function(t){t={load:"function"==typeof t.load?t.load:function(){e.log("AutoResponsive.Loader::_makeCfg: the load function in user's config is undefined!","warn")},diff:t.diff||0,mod:"manual"==t.mod?"manual":"auto",qpt:15},this.config=t},changeCfg:function(t){this.stop(),this._makeCfg(e.merge(this.config,t)),this._reset()},__doScroll:function(){var t=this,i=t.owner,n=t.config;if("up"!==t.__scrollDirection&&(e.log("AutoResponsive.Loader::__doScroll..."),!t.__loading)){if(i.isAdjusting())return t.__onScroll(),void 0;var o=e.get(i.get("container"));if(o.offsetWidth){var a=r.offset(o).top,u=n.diff,l=i.getMinColHeight(),c=r.scrollTop(s),f=r.height(s);u+c+f>=a+l&&t.load()}}},load:function(){function t(e,t){n.__addItems(e,function(){t&&t.call(n),n.__doScroll()}),n.__loading=0}function i(){n.stop()}var n=this,r=n.config,o=r.load;return n.__stopped?(e.log("AutoResponsive.Loader::load: this loader has stopped, please to resume!","warn"),void 0):(e.log("AutoResponsive.Loader::loading..."),n.__loading=1,o&&o(t,i),void 0)},isLoading:function(){return this.__loading},isStarted:function(){return this.__started},isStopped:function(){return this.__stopped},isDestroyed:function(){return this.__destroyed},__addItems:function(e,t){var n=this;i(e,n.__appendItems,n,function(){t&&t.call(n),n.fire("autoresponsive.loader.complete",{items:e})}).start()},__appendItems:function(t){var i=this,n=i.owner;t=e.makeArray(t),n.append(t)},__bindMethods:function(){var e=this,t=e.owner,i={min:0,max:0};t.on("afterLocate",function(e){i=e.autoResponsive.curMinMaxColHeight}),t.getMaxColHeight=function(){return i.max},t.getMinColHeight=function(){return i.min},e.__onScroll=n(e.__doScroll,a,e,!0),e.__onMouseWheel=function(t){e.__scrollDirection=t.deltaY>0?"up":"down"}},start:function(){o.on(s,"mousewheel",this.__onMouseWheel),this.resume()},stop:function(){this.pause(),o.detach(s,"scroll",this.__onMouseWheel),this.__stopped=1},pause:function(){this.__destroyed||o.detach(s,"scroll",this.__onScroll)},resume:function(){var e=this;e.__destroyed||(o.on(s,"scroll",e.__onScroll),e.__started=1,e.__stopped=0)},destroy:function(){this.__destroyed=1}}),t},{requires:["dom","event"]});