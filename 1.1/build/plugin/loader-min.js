/*! autoResponsive - v1.1 - 2013-07-12 5:06:06 PM
* Copyright (c) 2013 xudafeng; Licensed  */
KISSY.add("gallery/autoResponsive/1.1/plugin/loader",function(t){"use strict";function e(t){return this instanceof e?(this._makeCfg(t),void 0):new e(t)}function i(e,i,n,r){var o,s={},a=[],u=n.config,l=u.qpt||15;return s.start=function(){a=a.concat(t.makeArray(e));var u=function(){for(var t=+new Date;a.length>0&&50>new Date-t;){var c=a.splice(0,l);i.call(n,c)}return a.length>0?(o=setTimeout(u,25),void 0):(r&&r.call(n,e),s.stop(),s=null,void 0)};u()},s.stop=function(){o&&(clearTimeout(o),a=[])},s}function n(t,e,i,n){var r;return function(){function o(){n||t.apply(s,a),r=null}var s=i||this,a=arguments;r?clearTimeout(r):n&&t.apply(s,a),r=setTimeout(o,e||100)}}var r=t.DOM,o=t.all,s=window,a=o(s),u=50;return t.augment(e,t.EventTarget,{init:function(t){this.owner=t,this.__bindMethods(),this._reset()},_reset:function(){var t=this,e=t.config,i=e.mod;t.__started=t.__destroyed=t.__stopped=0,"manual"===i||(t.__onScroll(),t.start())},_makeCfg:function(e){e={load:"function"==typeof e.load?e.load:function(){t.log("AutoResponsive.Loader::_makeCfg: the load function in user's config is undefined!","warn")},diff:e.diff||0,mod:"manual"==e.mod?"manual":"auto",qpt:15},this.config=e},changeCfg:function(e){this.stop(),this._makeCfg(t.merge(this.config,e)),this._reset()},__doScroll:function(){var e=this,i=e.owner,n=e.config;if("up"!==e.__scrollDirection&&(t.log("AutoResponsive.Loader::__doScroll..."),!e.__loading)){if(i.isAdjusting())return e.__onScroll(),void 0;var o=t.get(i.get("container"));if(o.offsetWidth){var s=r.offset(o).top,u=n.diff,l=i.getMinColHeight(),c=a.scrollTop(),f=a.height();u+c+f>=s+l&&e.load()}}},load:function(){function e(t,e){n.__addItems(t,function(){e&&e.call(n),n.__doScroll()}),n.__loading=0}function i(){n.stop()}var n=this,r=n.config,o=r.load;return n.__stopped?(t.log("AutoResponsive.Loader::load: this loader has stopped, please to resume!","warn"),void 0):(t.log("AutoResponsive.Loader::loading..."),n.__loading=1,o&&o(e,i),void 0)},isLoading:function(){return this.__loading},isStarted:function(){return this.__started},isStopped:function(){return this.__stopped},isDestroyed:function(){return this.__destroyed},__addItems:function(t,e){var n=this;i(t,n.__appendItems,n,function(){e&&e.call(n),n.fire("autoresponsive.loader.complete",{items:t})}).start()},__appendItems:function(e){var i=this,n=i.owner;e=t.makeArray(e),n.append(e)},__bindMethods:function(){var t=this,e=t.owner,i={min:0,max:0};e.on("afterSort",function(t){i=t.autoResponsive.curMinMaxColHeight}),e.getMaxColHeight=function(){return i.max},e.getMinColHeight=function(){return i.min},t.__onScroll=n(t.__doScroll,u,t,!0),t.__onMouseWheel=function(e){t.__scrollDirection=e.deltaY>0?"up":"down"}},start:function(){a.on("mousewheel",this.__onMouseWheel),this.resume()},stop:function(){this.pause(),a.detach("scroll",this.__onMouseWheel),this.__stopped=1},pause:function(){this.__destroyed||a.detach("scroll",this.__onScroll)},resume:function(){var t=this;t.__destroyed||(a.on("scroll",t.__onScroll),t.__started=1,t.__stopped=0)},destroy:function(){this.__destroyed=1}}),e},{requires:["dom","event"]});